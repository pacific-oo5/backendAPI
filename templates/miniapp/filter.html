{% extends "miniapp/base.html" %}

{% block title %}–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π{% endblock %}

{% block content %}
<div class="header">
    <h1 id="filter-header">üîç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫</h1>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–æ–∫ -->
<div id="tabs-container" class="tabs" style="display: none;"></div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–∏—Å–∫–∞ -->
<div id="tab-search" class="tab-content {% if profile_data.user_r != True %}active{% endif %}">
    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="filters-form">
        <div class="filter-group">
            <input
                type="text"
                id="search-input"
                class="search-input"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º..."
                value="{{ search_query }}"
                oninput="debouncedSearch()"
                onkeydown="if(event.key==='Enter'){this.blur(); debouncedSearch();}"
            >
            <div class="search-icon">üîç</div>
        </div>

        <div class="filter-row">
            <div class="filter-select">
                <select id="work-type-filter" onchange="applyFilters()">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã —Ä–∞–±–æ—Ç—ã</option>
                    {% for value, label in work_choices %}
                    <option value="{{ value }}" {% if work_type_selected == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-select">
                <select id="work-time-filter" onchange="applyFilters()">
                    <option value="">–í—Å–µ —Å–º–µ–Ω—ã</option>
                    {% for value, label in work_time_choices %}
                    <option value="{{ value }}" {% if work_time_selected == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="filter-row">
            <div class="filter-input">
                <input
                    type="number"
                    id="min-salary"
                    placeholder="–ú–∏–Ω. –∑–∞—Ä–ø–ª–∞—Ç–∞"
                    value="{{ min_salary }}"
                    oninput="debouncedSearch()"
                    inputmode="numeric"
                    pattern="\d*"
                    onkeydown="if(event.key==='Enter'){this.blur(); debouncedSearch();}"
                >
            </div>
            <div class="filter-input">
                <input
                    type="number"
                    id="max-salary"
                    placeholder="–ú–∞–∫—Å. –∑–∞—Ä–ø–ª–∞—Ç–∞"
                    value="{{ max_salary }}"
                    oninput="debouncedSearch()"
                    inputmode="numeric"
                    pattern="\d*"
                    onkeydown="if(event.key==='Enter'){this.blur(); debouncedSearch();}"
                >
            </div>
        </div>

        <div class="filter-checkbox">
            <label>
                <input
                    type="checkbox"
                    id="remote-filter"
                    {% if is_remote_selected %}checked{% endif %}
                    onchange="applyFilters()"
                >
                üìç –£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞
            </label>
        </div>

        <button class="btn-clear" onclick="clearFilters()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    <div id="search-vacancies">
        {% include "miniapp/partials/vacancy_list.html" %}
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ -->
<div id="tab-keywords" class="tab-content">
    <div class="filters-form">
        <h3>üìù –ú–æ–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</h3>
        <div id="keywords-message" style="margin: 10px 0; color: var(--tg-theme-hint-color, #666);">
            –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ‚Äî –±–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </div>
        <ul id="filterList"></ul>

        <div class="filter-row">
            <input type="text" id="newKeyword" class="search-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ..." onkeydown="if(event.key==='Enter'){addKeyword()}">
            <button onclick="addKeyword()" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
    <div id="keywords-vacancies"></div>
</div>

<div id="loading" class="loading" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="loading" class="loading" style="display: none;">
    –ó–∞–≥—Ä—É–∑–∫–∞...
</div>

<style>
    :root{
      --btn-bg: var(--tg-theme-button-color, #4f46e5);
      --btn-text: var(--tg-theme-button-text-color, #fff);
      --btn-bg-hover: #4338ca;
      --btn-bg-active: #3730a3;
    }
    .btn{
      -webkit-tap-highlight-color: transparent;
      appearance: none;
      border: 0;
      outline: 0;
      cursor: pointer;

      padding: 12px 16px;
      border-radius: 14px;
      font: 600 15px/1.1 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

      color: var(--btn-text);
      background: var(--btn-bg);
      box-shadow:
        0 6px 16px rgba(0,0,0,.12),
        inset 0 -2px 0 rgba(0,0,0,.15);

      transition: transform .15s ease, box-shadow .2s ease, background .15s ease, opacity .2s ease;
    }
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    .tab-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 12px;
        background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
    }
    .tab-btn.active {
        background: var(--tg-theme-button-color, #40a7e3);
        color: white;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    #filterList {
        margin: 10px 0;
        padding: 0;
        list-style: none;
    }
    #filterList li {
        background: #eee;
        padding: 8px 12px;
        border-radius: 8px;
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #filterList li span {
        cursor: pointer;
        color: red;
        font-weight: bold;
        margin-left: 10px;
    }

    .filters-form {
        background: var(--tg-theme-secondary-bg-color, #f8f9fa);
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 20px;
    }

    .filter-group {
        position: relative;
        margin-bottom: 16px;
    }

    .filter-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }

    .filter-select, .filter-input {
        flex: 1;
    }

    .filter-select select,
    .filter-input input {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        border-radius: 12px;
        background: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        font-family: 'Inter', sans-serif;
        font-size: 14px;
    }

    .filter-checkbox {
        margin: 16px 0;
    }

    .filter-checkbox label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-clear {
        width: 100%;
        padding: 12px;
        background: var(--tg-theme-hint-color, #999999);
        color: white;
        border: none;
        border-radius: 12px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        cursor: pointer;
    }

    .search-input {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        border-radius: 12px;
        background: var(--tg-theme-bg-color, #ffffff);
        color: var(--tg-theme-text-color, #000000);
        font-size: 14px;
    }

    .vacancy-card {
        background-color: var(--tg-theme-secondary-bg-color, #f8f9fa);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 16px;
        cursor: pointer;
    }
</style>

<script>
let tg = window.Telegram.WebApp;
let currentPage = 1;
let isLoading = false;
let debounceTimer;
let profileData = null;
let currentTab = "search";

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
async function initPage() {
    await loadProfile();
    setupEventListeners();
    setupTabs(); // —Å–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadProfile() {
    try {
        const tgId = tg.initDataUnsafe?.user?.id;
        if (!tgId) return;

        const response = await fetch(`/miniapp/profile/data/2/?tg_id=${tgId}`);
        if (response.ok) {
            profileData = await response.json();
            console.log('–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', profileData);
        }
    } catch (err) {
        console.error(err);
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∫–ª–∞–¥–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è user_r=False)
function setupTabs() {
    if (!profileData || profileData.user_r !== false) return; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ false

    const tabsContainer = document.getElementById("tabs-container");
    tabsContainer.style.display = "flex";

    tabsContainer.innerHTML = `
        <button class="tab-btn active" data-tab="search">üîç –ü–æ–∏—Å–∫</button>
        <button class="tab-btn" data-tab="keywords">üìù –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</button>
    `;

    tabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            showTab(tab);
        });
    });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function showTab(tab) {
    if (!profileData || profileData.user_r !== false) return;

    currentTab = tab;
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

    const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
    if (btn) btn.classList.add("active");

    document.getElementById('tab-search').classList.toggle('active', tab === 'search');
    document.getElementById('tab-keywords').classList.toggle('active', tab === 'keywords');

    if (tab === "keywords") {
        loadKeywords();
        loadVacanciesByKeywords();
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventListeners() {
    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    window.addEventListener('scroll', handleScroll);

    // –ö–ª–∏–∫ –ø–æ –≤–∞–∫–∞–Ω—Å–∏—è–º
    document.addEventListener('click', handleVacancyClick);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞
function handleScroll() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 && !isLoading) {
        if (currentTab === "search") {
            loadVacancies();
        } else if (currentTab === "keywords" && !profileData.user_r) {
            loadVacanciesByKeywords();
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –≤–∞–∫–∞–Ω—Å–∏–∏
function handleVacancyClick(e) {
    const card = e.target.closest('.vacancy-card');
    if (!card) return;

    const vacancyId = card.dataset.vacancyId;
    const tgId = tg.initDataUnsafe?.user?.id;
    let url = `/miniapp/vacancies/${vacancyId}/`;

    if (tgId) url += `?tg_id=${tgId}`;
    window.location.href = url;
}

// –§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ–≥–¥–∞)
function getFilters() {
    return {
        q: document.getElementById('search-input')?.value || '',
        work_type: document.getElementById('work-type-filter')?.value || '',
        work_time: document.getElementById('work-time-filter')?.value || '',
        min_salary: document.getElementById('min-salary')?.value || '',
        max_salary: document.getElementById('max-salary')?.value || '',
        is_remote: document.getElementById('remote-filter')?.checked ? 'true' : ''
    };
}

function applyFilters() {
    const filters = getFilters();
    updateURL(filters);
    currentPage = 1;
    loadVacancies();
}

function clearFilters() {
    ['search-input','work-type-filter','work-time-filter','min-salary','max-salary'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });

    const remoteFilter = document.getElementById('remote-filter');
    if (remoteFilter) remoteFilter.checked = false;

    updateURL({});
    currentPage = 1;
    loadVacancies();
}

function debouncedSearch() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(applyFilters, 500);
}

function updateURL(filters) {
    const params = new URLSearchParams();
    for (const [key, value] of Object.entries(filters)) {
        if (value) params.append(key, value);
    }
    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
async function loadVacancies() {
    if (isLoading) return;

    isLoading = true;
    document.getElementById('loading').style.display = 'block';

    const filters = getFilters();
    const params = new URLSearchParams({ page: currentPage, ...filters });

    try {
        // üîπ –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint
        const response = await fetch(`/miniapp/filter/?${params}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
            const data = await response.json();

            // üîπ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å
            const container = document.getElementById('search-vacancies');

            if (currentPage === 1) {
                container.innerHTML = data.html;
            } else {
                container.innerHTML += data.html;
            }

            if (data.has_next) currentPage++;
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π:', err);
    } finally {
        isLoading = false;
        document.getElementById('loading').style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è user_r=False)
async function loadKeywords() {
    if (profileData.user_r) return;

    try {
        const tgId = tg.initDataUnsafe?.user?.id;
        const res = await fetch(`/miniapp/filters/get/?tg_id=${tgId}`);

        if (res.ok) {
            const data = await res.json();
            renderFilters(data.filters);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:', error);
    }
}

async function addKeyword() {
    if (profileData.user_r) return;

    const keyword = document.getElementById("newKeyword").value.trim();
    if (!keyword) return;

    try {
        const tgId = tg.initDataUnsafe?.user?.id;
        const res = await fetch("/miniapp/filters/update/", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ tg_id: tgId, keyword, action: "add" })
        });

        if (res.ok) {
            const data = await res.json();
            renderFilters(data.filters);
            document.getElementById("newKeyword").value = "";
            loadVacanciesByKeywords();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞:', error);
    }
}

async function removeKeyword(keyword) {
    if (profileData.user_r) return;

    try {
        const tgId = tg.initDataUnsafe?.user?.id;
        const res = await fetch("/miniapp/filters/update/", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ tg_id: tgId, keyword, action: "remove" })
        });

        if (res.ok) {
            const data = await res.json();
            renderFilters(data.filters);
            loadVacanciesByKeywords();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞:', error);
    }
}

function renderFilters(filters) {
    const list = document.getElementById("filterList");
    const message = document.getElementById("keywords-message");

    list.innerHTML = "";

    if (!filters || filters.length === 0) {
        message.style.display = "block";
    } else {
        message.style.display = "none";
        filters.forEach(f => {
            const li = document.createElement("li");
            li.innerHTML = `${f} <span onclick="removeKeyword('${f}')">‚úñ</span>`;
            li.style.backgroundColor = "var(--tg-theme-bg-color, #ffffff)";
            list.appendChild(li);
        });
    }
}

async function loadVacanciesByKeywords() {
    if (!profileData || profileData.user_r !== false) return;
    try {
        const tgId = tg.initDataUnsafe?.user?.id;
        const res = await fetch(`/miniapp/vacancies/by_keywords/?tg_id=${tgId}`);
        if (res.ok) {
            const data = await res.json();
            const container = document.getElementById("keywords-vacancies");

            if (data.html && data.html.trim() !== "") {
                container.innerHTML = `
                    <div id="previous-vacancies" style="margin: 10px 0; font-weight: 500; color: var(--tg-theme-text-color, #000);">
                        –†–∞–Ω–µ–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏:
                    </div>
                    ${data.html}
                `;
            } else {
                container.innerHTML = "";
            }
        }
    } catch(err){ console.error(err); }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', initPage);
</script>
{% endblock %}