{% extends "miniapp/base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="header">
    <h1>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h1>
</div>

<div id="profile-container" class="profile-wrapper">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ–≤–µ—Ä–ª–µ–π + –∫–æ–Ω—Ç–µ–Ω—Ç) -->
<div id="overlay" class="overlay">
    <div class="modal-card">
        <button class="modal-close" aria-label="Close" onclick="closeModal()">√ó</button>
        <h3 class="modal-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º</h3>
        <div id="qrcode"></div>

        <div class="share-actions">
            <button class="btn full" onclick="shareNative()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="btn outline" onclick="shareToTelegram()">‚úàÔ∏è –í Telegram</button>
            <button class="btn ghost" onclick="copyProfileUrl()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>
    </div>
</div>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<style>
    .profile-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 32px;
        padding: 0 12px;
    }

    .profile-card {
        width: 100%;
        max-width: 420px;
        padding: 24px 20px;
        border-radius: 18px;
        background: var(--tg-theme-secondary-bg-color, #f7f8fa);
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        position: relative;
        animation: cardIn .35s ease;
    }

    @keyframes cardIn {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    .profile-top {
        display: flex;
        gap: 16px;
        align-items: center;
        margin-bottom: 14px;
    }

    .profile-avatar {
        min-width: 76px;
        width: 76px;
        height: 76px;
        border-radius: 50%;
        background: linear-gradient(135deg, #40a7e3, #2d8ac7);
        color: #fff;
        font-weight: 800;
        font-size: 28px;
        display: grid;
        place-items: center;
        box-shadow: 0 6px 16px rgba(64, 167, 227, 0.35);
    }

    .profile-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .profile-name {
        font-size: 18px;
        font-weight: 700;
        color: var(--tg-theme-text-color, #111);
        letter-spacing: -0.2px;
    }

    .profile-email {
        color: var(--tg-theme-hint-color, #666);
        font-size: 14px;
    }

    .profile-meta {
        margin-top: 10px;
        padding: 12px;
        border-radius: 14px;
        background: var(--tg-theme-bg-color, #fff);
        border: 1px solid var(--tg-theme-secondary-bg-color, #ececec);
    }

    .meta-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
        color: var(--tg-theme-text-color, #222);
    }

    .meta-row + .meta-row {
        border-top: 1px dashed var(--tg-theme-secondary-bg-color, #e5e5e5);
    }

    .right-buttons {
        margin-top: 16px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        align-items: center;
    }

    .icon-button {
        border: none;
        background: transparent;
        font-size: 20px;
        cursor: pointer;
        color: var(--tg-theme-button-color, #40a7e3);
        transition: transform .15s ease, opacity .15s ease;
    }

    .icon-button:hover { transform: translateY(-1px); opacity: 0.9; }

    .btn {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: .2px;
        border: 2px solid transparent;
        transition: all .2s ease;
        text-align: center;
    }
    .btn.full {
        background: var(--tg-theme-button-color, #40a7e3);
        color: var(--tg-theme-button-text-color, #fff);
    }
    .btn.outline {
        background: transparent;
        color: var(--tg-theme-button-color, #40a7e3);
        border-color: var(--tg-theme-button-color, #40a7e3);
    }
    .btn.ghost {
        background: var(--tg-theme-secondary-bg-color, #f0f3f6);
        color: var(--tg-theme-text-color, #222);
    }
    .btn:active { transform: translateY(1px); }

    /* ====== Modal / Overlay ====== */
    .overlay {
        position: fixed;
        inset: 0;
        display: none;            /* hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 9999;
        background: rgba(0,0,0,0.30);  /* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
        backdrop-filter: blur(10px);    /* –±–ª—é—Ä –≤—Å–µ–≥–æ —Ñ–æ–Ω–∞, –≤–∫–ª—é—á–∞—è –º–µ–Ω—é */
        -webkit-backdrop-filter: blur(10px);
        animation: overlayFade .25s ease forwards;
    }
    .overlay.show { display: flex; }

    @keyframes overlayFade {
        from { opacity: 0; }
        to   { opacity: 1; }
    }

    .modal-card {
        width: 92%;
        max-width: 360px;
        background: var(--tg-theme-bg-color, #fff);
        border-radius: 18px;
        box-shadow: 0 16px 48px rgba(0,0,0,0.20);
        position: relative;
        padding: 20px 18px 16px;
        animation: modalIn .25s cubic-bezier(.2,.8,.2,1);
        border: 1px solid var(--tg-theme-secondary-bg-color, #ececec);
    }

    @keyframes modalIn {
        from { transform: translateY(8px) scale(.98); opacity: 0; }
        to   { transform: translateY(0) scale(1); opacity: 1; }
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 12px;
        width: 32px;
        height: 32px;
        font-size: 22px;
        border-radius: 50%;
        border: none;
        background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        color: var(--tg-theme-text-color, #444);
        cursor: pointer;
        display: grid; place-items: center;
        transition: background .2s ease, transform .1s ease;
    }
    .modal-close:active { transform: scale(0.95); }

    .modal-title {
        margin: 6px 0 10px;
        font-weight: 800;
        text-align: center;
        color: var(--tg-theme-text-color, #111);
        letter-spacing: -0.2px;
    }

    #qrcode {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 6px;
        background: var(--tg-theme-secondary-bg-color, #f7f7f7);
        border-radius: 12px;
        margin: 10px auto 14px;
    }
    #qrcode canvas, #qrcode img {
        width: 210px;
        height: 210px;
        border-radius: 8px;
    }

    .share-actions {
        display: grid;
        gap: 10px;
    }
</style>

<script>
    let tg = window.Telegram.WebApp;
    const profileContainer = document.getElementById('profile-container');
    const overlay = document.getElementById('overlay');
    let profileUrl = "";

    function maskEmail(email) {
        if (!email || !email.includes('@')) return '‚Äî';
        const [local, domain] = email.split('@');
        const visible = local.slice(0, 4);
        return `${visible}${local.length > 4 ? '****' : ''}@${domain}`;
    }

    function initialsFromUsername(username) {
        if (!username) return 'U';
        return username[0].toUpperCase();
    }

    async function loadProfile() {
        const tgId = tg.initDataUnsafe?.user?.id;
        if (!tgId) {
            profileContainer.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram.</p>";
            return;
        }

        try {
            const res = await fetch(`/miniapp/profile/data/?tg_id=${tgId}`);
            const data = await res.json();

            if (data.status === "ok" && data.connected) {
                const user = data.site_user;
                const emailMasked = maskEmail(user.email);
                const initials = initialsFromUsername(user.username || user.first_name || '?');

                // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
                profileUrl = (window.location.origin || 'https://your-site.com') + `/user/${encodeURIComponent(user.username || 'me')}`;

                profileContainer.innerHTML = `
                    <div class="profile-card">
                        <div class="profile-top">
                            <div class="profile-avatar">${initials}</div>
                            <div class="profile-info">
                                <div class="profile-name">${user.username || (user.first_name || '')}</div>
                                <div class="profile-email">${emailMasked}</div>
                            </div>
                        </div>

                        <div class="profile-meta">
                            <div class="meta-row"><span>–ò–º—è</span><strong>${user.first_name || '‚Äî'}</strong></div>
                            <div class="meta-row"><span>–§–∞–º–∏–ª–∏—è</span><strong>${user.last_name || '‚Äî'}</strong></div>
                            <div class="meta-row"><span>Telegram</span><strong>${data.telegram?.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong></div>
                        </div>

                        <div class="right-buttons">
                            <button class="icon-button" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" onclick="openModal()">üîó</button>
                            <button class="btn outline" onclick="updateProfile()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            } else {
                profileContainer.innerHTML = `
                    <div class="profile-card">
                        <p>${data.message || "–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω."}</p>
                        <a href="/register-or-connect/" class="btn full">–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                    </div>
                `;
            }
        } catch (err) {
            console.error(err);
            profileContainer.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>";
        }
    }

    function updateProfile() {
        tg.showPopup({
            title: "–°–∫–æ—Ä–æ",
            message: "–§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ.",
            buttons: [{id: 'ok', type: 'close', text: '–û–∫'}]
        });
    }

    function openModal() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
        overlay.classList.add('show');

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR
        const box = document.getElementById("qrcode");
        box.innerHTML = ""; // –æ—á–∏—Å—Ç–∏—Ç—å –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π

        // –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–∞ qrcodejs (–æ–Ω –ø–æ–º–µ—á–µ–Ω defer ‚Äî —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω)
        try {
            new QRCode(box, {
                text: profileUrl || window.location.href,
                width: 210,
                height: 210,
                correctLevel: QRCode.CorrectLevel.M
            });
        } catch (e) {
            console.error("QR generation error:", e);
            box.innerHTML = "<p style='color:#c00;'>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥</p>";
        }
    }

    function closeModal() {
        overlay.classList.remove('show');
    }

    async function shareNative() {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å",
                    text: "–ü–æ—Å–º–æ—Ç—Ä–∏ –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å:",
                    url: profileUrl
                });
            } catch (err) {
                // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ—Ç–º–µ–Ω–∏—Ç—å ‚Äî —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                console.warn("Share canceled or failed", err);
            }
        } else {
            tg.showPopup({
                title: "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ",
                message: "–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.",
                buttons: [{id: 'ok', type: 'close', text: '–û–∫'}]
            });
        }
    }

    function shareToTelegram() {
        const shareText = "–ü–æ—Å–º–æ—Ç—Ä–∏ –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å:";
        const link = `https://t.me/share/url?url=${encodeURIComponent(profileUrl)}&text=${encodeURIComponent(shareText)}`;
        tg.openTelegramLink(link);
    }

    async function copyProfileUrl() {
        try {
            await navigator.clipboard.writeText(profileUrl);
            tg.showPopup({
                title: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",
                message: "–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.",
                buttons: [{id: 'ok', type: 'close', text: '–û–∫'}]
            });
        } catch (e) {
            console.warn("Clipboard error", e);
            tg.showPopup({
                title: "–û—à–∏–±–∫–∞",
                message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É.",
                buttons: [{id: 'ok', type: 'close', text: '–û–∫'}]
            });
        }
    }

    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}
