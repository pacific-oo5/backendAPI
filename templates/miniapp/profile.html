{% extends "miniapp/base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}

<style>
  .tabs {
    display: flex;
    cursor: pointer;
    margin-bottom: 10px;
    gap: 4px;
    padding: 0 12px;
  }

  .tab {
    padding: 12px 20px;
    border-radius: 12px 12px 0 0;
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    color: var(--tg-theme-hint-color, #666);
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    flex: 1;
    text-align: center;
  }

  .tab.active {
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    font-weight: 600;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  }

  .content {
    background: var(--tg-theme-bg-color, #fff);
    border-radius: 0 0 12px 12px;
    min-height: 300px;
    position: relative;
    overflow: hidden;
  }

  .tab-content {
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    padding: 16px;
  }

  .tab-content.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .vacancy-list, .anketa-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .response-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .response-card {
    background: var(--tg-theme-secondary-bg-color, #f8f9fa);
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--tg-theme-section-bg-color, #e9ecef);
  }

  .response-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 12px;
  }

  .response-title {
    font-weight: 600;
    color: var(--tg-theme-text-color, #000);
    font-size: 16px;
  }

  .response-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-new {
    background: #3b82f6;
    color: white;
  }

  .status-viewed {
    background: #f59e0b;
    color: white;
  }

  .status-accepted {
    background: #10b981;
    color: white;
  }

  .status-rejected {
    background: #ef4444;
    color: white;
  }

  .response-meta {
    color: var(--tg-theme-hint-color, #666);
    font-size: 14px;
    margin-top: 8px;
  }
</style>

<div class="header">
    <h1>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h1>
</div>

<div id="profile-container" class="profile-wrapper">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<div class="tabs">
  <div class="tab active" data-tab="items">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>
  <div class="tab" data-tab="responses">–û—Ç–∫–ª–∏–∫–∏</div>
</div>

<div class="content">
  <div class="tab-content active" id="tab-items">
    <div id="items-container"></div>
    <div id="items-load-more" style="text-align:center; margin-top:12px; display:none;">
      <button onclick="loadMoreItems()" class="btn outline">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>
    </div>
  </div>

  <div class="tab-content" id="tab-responses">
    <div id="responses-container">
      <p style="text-align:center; padding:40px 20px; color:var(--tg-theme-hint-color);">
        –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∫–ª–∏–∫–æ–≤...
      </p>
    </div>
  </div>
</div>

<script>
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const tabId = tab.dataset.tab;

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    contents.forEach(c => {
      c.style.opacity = '0';
      c.style.transform = 'translateY(10px)';
      setTimeout(() => {
        c.classList.remove('active');
      }, 150);
    });

    setTimeout(() => {
      const targetContent = document.getElementById('tab-' + tabId);
      targetContent.classList.add('active');
      targetContent.style.opacity = '1';
      targetContent.style.transform = 'translateY(0)';

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
      if (tabId === 'responses') {
        loadResponses();
      }
    }, 150);
  });
});

let tg = window.Telegram.WebApp;
const profileContainer = document.getElementById('profile-container');
const itemsContainer = document.getElementById('items-container');
const responsesContainer = document.getElementById('responses-container');
const itemsLoadMore = document.getElementById('items-load-more');
let profileData = null;
let currentItemsPage = 1;
let hasMoreItems = false;

function maskEmail(email) {
    if (!email || !email.includes('@')) return '‚Äî';
    const [local, domain] = email.split('@');
    const visible = local.slice(0, 4);
    return `${visible}${local.length > 4 ? '****' : ''}@${domain}`;
}

function initialsFromUsername(username) {
    if (!username) return 'U';
    return username[0].toUpperCase();
}

async function loadProfile() {
    const tgId = tg.initDataUnsafe?.user?.id;
    if (!tgId) {
        profileContainer.innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram.</p>";
        return;
    }

    try {
        const res = await fetch(`/miniapp/profile/data/?tg_id=${tgId}`);
        const data = await res.json();
        profileData = data;

        if (data.status === "ok" && data.connected) {
            const user = data.site_user;
            const emailMasked = maskEmail(user.email);
            const initials = initialsFromUsername(user.username || user.first_name || '?');

            profileUrl = (window.location.origin || 'https://your-site.com') + `/user/${encodeURIComponent(user.id || 'me')}`;

            profileContainer.innerHTML = `
                <div class="profile-card">
                    <div class="profile-top">
                        <div class="profile-avatar">${initials}</div>
                        <div class="profile-info">
                            <div class="profile-name">${user.username || (user.first_name || '')}</div>
                            <div class="profile-email">${emailMasked}</div>
                        </div>
                    </div>

                    <div class="profile-meta">
                        <div class="meta-row"><span>–ò–º—è</span><strong>${user.first_name || '‚Äî'}</strong></div>
                        <div class="meta-row"><span>–§–∞–º–∏–ª–∏—è</span><strong>${user.last_name || '‚Äî'}</strong></div>
                        <div class="meta-row"><span>Telegram</span><strong>${data.telegram?.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong></div>
                    </div>

                    <div class="right-buttons">
                        <button class="icon-button" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" onclick="openModal()">üîó</button>
                        <button class="btn outline" onclick="updateProfile()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
            `;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º items –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
            loadItems();
        } else {
            profileContainer.innerHTML = `
                <div class="profile-card">
                    <p>${data.message || "–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω."}</p>
                    <a href="#" class="btn full">–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
                </div>
            `;
        }
    } catch (err) {
        console.error(err);
        profileContainer.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>";
    }
}

async function loadItems(page = 1) {
    const tgId = tg.initDataUnsafe?.user?.id;
    if (!tgId) return;

    try {
        const res = await fetch(`/miniapp/profile/data/?tg_id=${tgId}&page=${page}`);
        const data = await res.json();

        if (data.status === "ok") {
            if (page === 1) {
                itemsContainer.innerHTML = data.html || '<p>–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>';
            } else {
                itemsContainer.insertAdjacentHTML('beforeend', data.html || '');
            }

            hasMoreItems = data.has_next;
            itemsLoadMore.style.display = hasMoreItems ? 'block' : 'none';
        }
    } catch (err) {
        console.error(err);
        itemsContainer.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>";
    }
}

async function loadResponses() {
    const tgId = tg.initDataUnsafe?.user?.id;
    if (!tgId) return;

    try {
        const res = await fetch(`/miniapp/profile/responses/?tg_id=${tgId}`);
        const data = await res.json();

        if (data.status === "ok") {
            if (data.responses && data.responses.length > 0) {
                responsesContainer.innerHTML = data.responses.map(response => `
                    <div class="response-card">
                        <div class="response-header">
                            <div class="response-title">${response.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                            <div class="response-status status-${response.status || 'new'}">
                                ${getStatusText(response.status)}
                            </div>
                        </div>
                        <div class="response-meta">
                            ${response.date ? `–î–∞—Ç–∞: ${new Date(response.date).toLocaleDateString()}` : ''}
                            ${response.message ? `<br>–°–æ–æ–±—â–µ–Ω–∏–µ: ${response.message}` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                responsesContainer.innerHTML = '<p style="text-align:center; padding:40px 20px;">–ù–µ—Ç –æ—Ç–∫–ª–∏–∫–æ–≤</p>';
            }
        }
    } catch (err) {
        console.error(err);
        responsesContainer.innerHTML = '<p style="text-align:center; padding:40px 20px; color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∫–ª–∏–∫–æ–≤</p>';
    }
}

function getStatusText(status) {
    const statusMap = {
        'new': '–ù–æ–≤—ã–π',
        'viewed': '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ',
        'accepted': '–ü—Ä–∏–Ω—è—Ç–æ',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
    };
    return statusMap[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function loadMoreItems() {
    currentItemsPage++;
    loadItems(currentItemsPage);
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (updateProfile, openModal, closeModal, shareNative, shareToTelegram, copyProfileUrl)
// –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–∞–∫ –≤ –≤–∞—à–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ

document.addEventListener('DOMContentLoaded', loadProfile);
</script>

<!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º –∏ —Å—Ç–∏–ª—è–º–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div id="overlay" class="overlay">
    <div class="modal-card">
        <button class="modal-close" aria-label="Close" onclick="closeModal()">√ó</button>
        <h3 class="modal-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ—Ñ–∏–ª–µ–º</h3>
        <div id="qrcode"></div>

        <div class="share-actions">
            <button class="btn full" onclick="shareNative()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="btn outline" onclick="shareToTelegram()">‚úàÔ∏è –í Telegram</button>
            <button class="btn ghost" onclick="copyProfileUrl()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </div>
    </div>
</div>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<style>
    /* –°—Ç–∏–ª–∏ –∏–∑ –≤–∞—à–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    .profile-wrapper { display: flex; justify-content: center; margin-top: 32px; padding: 0 12px; }
    .profile-card { width: 100%; max-width: 420px; padding: 24px 20px; border-radius: 18px; background: var(--tg-theme-secondary-bg-color, #f7f8fa); box-shadow: 0 8px 24px rgba(0,0,0,0.08); position: relative; animation: cardIn .35s ease; }
    @keyframes cardIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .profile-top { display: flex; gap: 16px; align-items: center; margin-bottom: 14px; }
    .profile-avatar { min-width: 76px; width: 76px; height: 76px; border-radius: 50%; background: linear-gradient(135deg, #40a7e3, #2d8ac7); color: #fff; font-weight: 800; font-size: 28px; display: grid; place-items: center; box-shadow: 0 6px 16px rgba(64, 167, 227, 0.35); }
    .profile-info { display: flex; flex-direction: column; gap: 4px; }
    .profile-name { font-size: 18px; font-weight: 700; color: var(--tg-theme-text-color, #111); letter-spacing: -0.2px; }
    .profile-email { color: var(--tg-theme-hint-color, #666); font-size: 14px; }
    .profile-meta { margin-top: 10px; padding: 12px; border-radius: 14px; background: var(--tg-theme-bg-color, #fff); border: 1px solid var(--tg-theme-secondary-bg-color, #ececec); }
    .meta-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; color: var(--tg-theme-text-color, #222); }
    .meta-row + .meta-row { border-top: 1px dashed var(--tg-theme-secondary-bg-color, #e5e5e5); }
    .right-buttons { margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end; align-items: center; }
    .icon-button { border: none; background: transparent; font-size: 20px; cursor: pointer; color: var(--tg-theme-button-color, #40a7e3); transition: transform .15s ease, opacity .15s ease; }
    .icon-button:hover { transform: translateY(-1px); opacity: 0.9; }
    .btn { display: inline-block; padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: .2px; border: 2px solid transparent; transition: all .2s ease; text-align: center; }
    .btn.full { background: var(--tg-theme-button-color, #40a7e3); color: var(--tg-theme-button-text-color, #fff); }
    .btn.outline { background: transparent; color: var(--tg-theme-button-color, #40a7e3); border-color: var(--tg-theme-button-color, #40a7e3); }
    .btn.ghost { background: var(--tg-theme-secondary-bg-color, #f0f3f6); color: var(--tg-theme-text-color, #222); }
    .btn:active { transform: translateY(1px); }
    .overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; background: rgba(0,0,0,0.30); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: overlayFade .25s ease forwards; }
    .overlay.show { display: flex; }
    @keyframes overlayFade { from { opacity: 0; } to { opacity: 1; } }
    .modal-card { width: 92%; max-width: 360px; background: var(--tg-theme-bg-color, #fff); border-radius: 18px; box-shadow: 0 16px 48px rgba(0,0,0,0.20); position: relative; padding: 20px 18px 16px; animation: modalIn .25s cubic-bezier(.2,.8,.2,1); border: 1px solid var(--tg-theme-secondary-bg-color, #ececec); }
    @keyframes modalIn { from { transform: translateY(8px) scale(.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .modal-close { position: absolute; top: 10px; right: 12px; width: 32px; height: 32px; font-size: 22px; border-radius: 50%; border: none; background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color, #444); cursor: pointer; display: grid; place-items: center; transition: background .2s ease, transform .1s ease; }
    .modal-close:active { transform: scale(0.95); }
    .modal-title { margin: 6px 0 10px; font-weight: 800; text-align: center; color: var(--tg-theme-text-color, #111); letter-spacing: -0.2px; }
    #qrcode { display: flex; justify-content: center; align-items: center; padding: 6px; background: var(--tg-theme-secondary-bg-color, #f7f7f7); border-radius: 12px; margin: 10px auto 14px; }
    #qrcode canvas, #qrcode img { width: 210px; height: 210px; border-radius: 8px; }
    .share-actions { display: grid; gap: 10px; }
</style>

{% endblock %}