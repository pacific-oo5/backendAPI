{% extends "miniapp/base.html" %}

{% block content %}
<div class="header">
    <h1>üíñ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</h1>
</div>

<div id="vacancy-container">
    {% if has_tg_id %}
        {% if error %}
            <div style="background:#ffe5e5;padding:12px;text-align:center;margin:10px;border-radius:8px;">
                {{ error }}
            </div>
        {% elif vacancies %}
            {% include "miniapp/partials/vacancy_list.html" with vacancies=vacancies %}
        {% else %}
            <div style="text-align:center;padding:40px;color:#666;">
                <p>üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π</p>
                <p>–ù–∞–∂–º–∏—Ç–µ ‚ù§Ô∏è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ—ë –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</p>
            </div>
        {% endif %}
    {% else %}
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ...</p>
    {% endif %}
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

{% if not has_tg_id %}
// –ï—Å–ª–∏ TG ID –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ —à–∞–±–ª–æ–Ω–µ, –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ JavaScript
const container = document.getElementById('vacancy-container');
const initData = tg.initData;

if (!initData) {
    container.innerHTML = '<div style="background:#ffe5e5;padding:12px;text-align:center;">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram</div>';
} else {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ —á–µ—Ä–µ–∑ AJAX
    fetch("{% url 'miniapp:favorite_vacancies_data' %}?initData=" + encodeURIComponent(initData), {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-Telegram-Init-Data': initData
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            container.innerHTML = data.html || '<div style="text-align:center;padding:40px;color:#666;">üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π</div>';
        } else {
            container.innerHTML = '<div style="background:#ffe5e5;padding:12px;text-align:center;">' + data.message + '</div>';
        }
    })
    .catch(err => {
        console.error("Fetch error:", err);
        container.innerHTML = '<div style="background:#ffe5e5;padding:12px;text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
    });
}
{% endif %}
</script>
{% endblock %}